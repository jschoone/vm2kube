---

- name: Install Container Registry
  hosts: registry
  become: true
  handlers:
  - name: restart haproxy
    systemd:
      name: haproxy
      state: restarted

  tasks:
  - include_tasks: install_docker.yaml
  - name: Install Docker Python Libs
    package:
      name: "{{ docker_py }}"
      state: present

  - name: Run Registry
    docker_container:
      name: registry
      image: registry:2
      restart_policy: always
      state: started
      ports:
      - "5000:5000"

  - name: Install HAProxy
    package:
      name: haproxy
      state: present

  - name: Slurp Certificate
    slurp:
      src: "{{ app_crt }}"
    register: crt_content

  - name: Slurp Certificate Key
    slurp:
      src: "{{ app_crt_key }}"
    register: crt_key_content

  - name: Create HAProxy Cert Directory
    file:
      path: "{{ haproxy_cert_dir }}"
      state: directory

  - copy:
      dest: "{{ haproxy_cert_dir}}/app.pem"
      content: |
        {{ crt_content.content | b64decode }}
        {{ crt_key_content.content | b64decode }}
    notify: restart haproxy

  - name: Configure HAProxy
    template:
      src: etc/haproxy/registry.cfg.j2
      dest: /etc/haproxy/haproxy.cfg
    notify: restart haproxy

  - name: Enable HAProxy
    systemd:
      name: haproxy
      state: started
      enabled: true
